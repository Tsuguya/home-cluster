kubeProxy:
  enabled: false

kubeEtcd:
  endpoints:
    - 192.168.0.230
    - 192.168.0.231
    - 192.168.0.232

nodeExporter:
  operatingSystems:
    aix:
      enabled: false
    darwin:
      enabled: false

prometheusOperator:
  logFormat: json
  prometheusConfigReloader:
    resources:
      requests:
        cpu: 10m
        memory: 32Mi
      limits:
        memory: 64Mi
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      memory: 128Mi

prometheus:
  prometheusSpec:
    externalLabels:
      cluster: home-cluster
    logFormat: json
    enableRemoteWriteReceiver: true
    retention: 14d
    resources:
      limits:
        memory: 2Gi
      requests:
        cpu: 200m
        memory: 1Gi
    storageSpec:
      volumeClaimTemplate:
        spec:
          storageClassName: qnap-iscsi
          resources:
            requests:
              storage: 20Gi

kube-state-metrics:
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      memory: 128Mi

prometheus-node-exporter:
  resources:
    requests:
      cpu: 10m
      memory: 32Mi
    limits:
      memory: 64Mi

grafana:
  sidecar:
    resources:
      requests:
        cpu: 10m
        memory: 64Mi
      limits:
        memory: 256Mi
    dashboards:
      skipReload: true
      initDashboards: true # no running sidecar â€” restart pod after dashboard ConfigMap changes
      watchMethod: LIST
    datasources:
      skipReload: true
      initDatasources: true
      watchMethod: LIST
  resources:
    requests:
      cpu: 25m
      memory: 256Mi
    limits:
      memory: 512Mi
  admin:
    existingSecret: grafana-admin
    userKey: admin-user
    passwordKey: admin-password
  grafana.ini:
    analytics:
      check_for_updates: false
      check_for_plugin_updates: false
      reporting_enabled: false
    security:
      disable_gravatar: true
    log:
      mode: console
    log.console:
      format: json
    database:
      type: postgres
      host: shared-pg-rw.database.svc:5432
      name: grafana
    dashboards:
      default_home_dashboard_path: /tmp/dashboards/pod-resources.json
    server:
      root_url: https://grafana.infra.tgy.io
    auth:
      disable_login_form: true
    auth.basic:
      enabled: true
    auth.generic_oauth:
      enabled: true
      name: Kanidm
      scopes: openid profile email groups
      auth_url: https://idm.infra.tgy.io/ui/oauth2
      token_url: https://idm.infra.tgy.io/oauth2/token
      api_url: https://idm.infra.tgy.io/oauth2/openid/grafana/userinfo
      use_pkce: true
      use_refresh_token: true
      email_attribute_path: email
      login_attribute_path: preferred_username
      name_attribute_path: name
      allow_sign_up: true
      auto_login: true
      role_attribute_path: grafana_role
  envValueFrom:
    GF_DATABASE_USER:
      secretKeyRef:
        name: grafana-pg-credentials
        key: username
    GF_DATABASE_PASSWORD:
      secretKeyRef:
        name: grafana-pg-credentials
        key: password
    GF_AUTH_GENERIC_OAUTH_CLIENT_ID:
      secretKeyRef:
        name: kanidm-grafana-oauth
        key: clientID
    GF_AUTH_GENERIC_OAUTH_CLIENT_SECRET:
      secretKeyRef:
        name: kanidm-grafana-oauth
        key: clientSecret
    GF_DISCORD_WEBHOOK_URL:
      secretKeyRef:
        name: discord-webhook-grafana
        key: url
  alerting:
    contactpoints.yaml:
      apiVersion: 1
      contactPoints:
        - orgId: 1
          name: discord
          receivers:
            - uid: discord
              type: discord
              settings:
                url: $__env{GF_DISCORD_WEBHOOK_URL}
                use_discord_username: true
    policies.yaml:
      apiVersion: 1
      policies:
        - orgId: 1
          receiver: discord
          group_by: ['grafana_folder', 'alertname']
          group_wait: 30s
          group_interval: 5m
          repeat_interval: 4h
  additionalDataSources:
    - name: Loki
      uid: loki
      type: loki
      url: http://loki-gateway.monitoring.svc:80
      access: proxy
      isDefault: false
      jsonData:
        derivedFields:
          - datasourceUid: tempo
            matcherRegex: '"trace_id":"(\w+)"'
            name: TraceID
            url: ${__value.raw}
    - name: Tempo
      uid: tempo
      type: tempo
      url: http://tempo.monitoring.svc:3200
      access: proxy
      isDefault: false
      jsonData:
        tracesToLogsV2:
          datasourceUid: loki
          filterByTraceID: true
          filterBySpanID: true
          spanStartTimeShift: "-5m"
          spanEndTimeShift: "5m"
        lokiSearch:
          datasourceUid: loki
        nodeGraph:
          enabled: true
        serviceMap:
          datasourceUid: prometheus

alertmanager:
  alertmanagerSpec:
    logFormat: json
    automountServiceAccountToken: false
    alertmanagerConfiguration:
      name: discord
    resources:
      limits:
        memory: 256Mi
      requests:
        cpu: 50m
        memory: 128Mi
