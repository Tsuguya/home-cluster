apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: discord-notify
  namespace: argo
spec:
  templates:
    - name: send
      container:
        image: curlimages/curl:8.18.0
        resources:
          requests:
            cpu: 10m
            memory: 16Mi
          limits:
            memory: 64Mi
        command: [sh, -c]
        args:
          - |
            URL="https://argo.infra.tgy.io/workflows/{{workflow.namespace}}/{{workflow.name}}"
            TITLE="Workflow {{workflow.status}}: {{workflow.name}}"
            NS="{{workflow.namespace}}"
            PAYLOAD="{\"embeds\":[{\"title\":\"$TITLE\",\"url\":\"$URL\",\"color\":15298678,\"fields\":[{\"name\":\"Namespace\",\"value\":\"$NS\",\"inline\":true}]}]}"
            curl -sfS -X POST "$DISCORD_WEBHOOK_URL" \
              -H "Content-Type: application/json" \
              -d "$PAYLOAD"
        env:
          - name: DISCORD_WEBHOOK_URL
            valueFrom:
              secretKeyRef:
                name: discord-webhook-argo
                key: url
