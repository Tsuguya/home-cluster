apiVersion: v1
kind: ServiceAccount
metadata:
  name: talos-build-executor
  namespace: talos-build
automountServiceAccountToken: true
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: talos-build-executor
  namespace: talos-build
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argo-workflows-edit
subjects:
  - kind: ServiceAccount
    name: talos-build-executor
    namespace: talos-build
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: talos-secureboot-build
  namespace: talos-build
spec:
  activeDeadlineSeconds: 1800
  serviceAccountName: talos-build-executor
  entrypoint: main
  arguments:
    parameters:
      - name: version
  podMetadata:
    labels:
      talos-build: "true"
  securityContext:
    runAsUser: 0
    runAsNonRoot: false
    fsGroup: 0
    seccompProfile:
      type: RuntimeDefault
  volumes:
    - name: secureboot-keys
      secret:
        secretName: secureboot-signing-keys
    - name: scripts
      configMap:
        name: talos-build-scripts
        defaultMode: 0755
  affinity:
    nodeAffinity:
      preferredDuringSchedulingIgnoredDuringExecution:
        - weight: 100
          preference:
            matchExpressions:
              - key: kubernetes.io/hostname
                operator: In
                values:
                  - wn-03
  templates:
    - name: main
      steps:
        - - name: build-secureboot-installer
            template: run-imager
            arguments:
              parameters:
                - name: output-type
                  value: secureboot-installer
          - name: build-secureboot-iso
            template: run-imager
            arguments:
              parameters:
                - name: output-type
                  value: secureboot-iso
          - name: build-iso
            template: run-imager
            arguments:
              parameters:
                - name: output-type
                  value: iso
        - - name: push-installer
            template: push-installer
            arguments:
              artifacts:
                - name: artifact
                  from: "{{steps.build-secureboot-installer.outputs.artifacts.output}}"
          - name: push-iso
            template: push-iso
            arguments:
              artifacts:
                - name: sb-iso
                  from: "{{steps.build-secureboot-iso.outputs.artifacts.output}}"
                - name: iso
                  from: "{{steps.build-iso.outputs.artifacts.output}}"
        - - name: finalize-release
            template: finalize-release

    - name: run-imager
      inputs:
        parameters:
          - name: output-type
      volumes:
        - name: docker-config
          emptyDir: {}
      initContainers:
        - name: setup-registry-auth
          image: alpine:3.23
          command: [sh, -c]
          args:
            - |
              printf '{"auths":{"ghcr.io":{"auth":"%s"}}}' "$(printf '%s:%s' tsuguya "$GITHUB_TOKEN" | base64)" > /docker-config/config.json
          env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-pat-talos-build
                  key: credential
          volumeMounts:
            - name: docker-config
              mountPath: /docker-config
      container:
        image: "ghcr.io/tsuguya/imager:{{workflow.parameters.version}}"
        command: [/bin/imager]
        args:
          - "{{inputs.parameters.output-type}}"
          - --arch
          - amd64
          - --system-extension-image
          - ghcr.io/tsuguya/iscsi-tools:v0.2.0-pre-consolidation
          - --system-extension-image
          - ghcr.io/siderolabs/spin:v0.22.0
          - --base-installer-image
          - "ghcr.io/tsuguya/installer-base:{{workflow.parameters.version}}"
          - --extra-kernel-arg
          - "-lockdown"
          - --extra-kernel-arg
          - "lockdown=integrity"
        env:
          - name: DOCKER_CONFIG
            value: /docker-config
        resources:
          requests:
            cpu: 100m
            memory: 512Mi
          limits:
            memory: 2Gi
        volumeMounts:
          - name: secureboot-keys
            mountPath: /secureboot
            readOnly: true
          - name: docker-config
            mountPath: /docker-config
            readOnly: true
      outputs:
        artifacts:
          - name: output
            path: /out

    - name: push-installer
      inputs:
        artifacts:
          - name: artifact
            path: /tmp/artifact/
      container:
        image: alpine:3.23
        command: [sh, /scripts/push-installer.sh]
        securityContext:
          runAsUser: 65532
          runAsNonRoot: true
        env:
          - name: VERSION
            value: "{{workflow.parameters.version}}"
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat-talos-build
                key: credential
          - name: DOCKER_CONFIG
            value: /tmp
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi
        volumeMounts:
          - name: scripts
            mountPath: /scripts
            readOnly: true

    - name: push-iso
      inputs:
        artifacts:
          - name: sb-iso
            path: /tmp/sb-iso/
          - name: iso
            path: /tmp/iso/
      container:
        image: alpine:3.23
        command: [sh, /scripts/push-iso.sh]
        securityContext:
          runAsUser: 65532
          runAsNonRoot: true
        env:
          - name: VERSION
            value: "{{workflow.parameters.version}}"
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat-talos-build
                key: credential
          - name: GH_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat-talos-build
                key: credential
        resources:
          requests:
            cpu: 50m
            memory: 256Mi
          limits:
            memory: 1Gi
        volumeMounts:
          - name: scripts
            mountPath: /scripts
            readOnly: true

    - name: finalize-release
      container:
        image: alpine:3.23
        command: [sh, /scripts/finalize-release.sh]
        securityContext:
          runAsUser: 65532
          runAsNonRoot: true
        env:
          - name: VERSION
            value: "{{workflow.parameters.version}}"
          - name: GH_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat-talos-build
                key: credential
        resources:
          requests:
            cpu: 10m
            memory: 64Mi
          limits:
            memory: 128Mi
        volumeMounts:
          - name: scripts
            mountPath: /scripts
            readOnly: true
