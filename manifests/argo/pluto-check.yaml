apiVersion: v1
kind: ServiceAccount
metadata:
  name: pluto-checker
  namespace: argo
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: pluto-checker
  namespace: argo
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argo-workflows-edit
subjects:
  - kind: ServiceAccount
    name: pluto-checker
    namespace: argo
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: pluto-checker
rules:
  - apiGroups: ["*"]
    resources: ["*"]
    verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: pluto-checker
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: pluto-checker
subjects:
  - kind: ServiceAccount
    name: pluto-checker
    namespace: argo
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: pluto-check
  namespace: argo
spec:
  activeDeadlineSeconds: 2400
  serviceAccountName: pluto-checker
  entrypoint: main
  templates:
    - name: main
      steps:
        - - name: detect-in-cluster
            template: detect-in-cluster
            continueOn:
              failed: true
          - name: detect-helm
            template: detect-helm
            continueOn:
              failed: true
        - - name: ai-fix
            template: ai-fix
            when: "{{steps.detect-in-cluster.status}} == Failed || {{steps.detect-helm.status}} == Failed"
        - - name: fail-if-deprecated
            template: fail-if-deprecated
            when: "{{steps.detect-in-cluster.status}} == Failed || {{steps.detect-helm.status}} == Failed"

    - name: detect-in-cluster
      container:
        image: us-docker.pkg.dev/fairwinds-ops/oss/pluto:v5.22.8
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            memory: 128Mi
        command: [/pluto]
        args:
          - detect-all-in-cluster
          - --target-versions
          - k8s=v1.36.0
          - -o
          - wide

    - name: detect-helm
      container:
        image: us-docker.pkg.dev/fairwinds-ops/oss/pluto:v5.22.8
        resources:
          requests:
            cpu: 10m
            memory: 32Mi
          limits:
            memory: 128Mi
        command: [/pluto]
        args:
          - detect-helm
          - --target-versions
          - k8s=v1.36.0
          - -o
          - wide

    - name: ai-fix
      timeout: "30m"
      script:
        image: node:24-alpine
        resources:
          requests:
            cpu: 100m
            memory: 256Mi
          limits:
            memory: 1Gi
        command: [sh]
        env:
          - name: CLAUDE_CODE_OAUTH_TOKEN
            valueFrom:
              secretKeyRef:
                name: claude-code-token
                key: credential
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat-pluto-fix
                key: credential
        source: |
          set -euo pipefail

          echo "=== Installing dependencies ==="
          apk add --no-cache git github-cli curl tar python3 >/dev/null 2>&1

          PLUTO_VERSION=v5.22.7
          curl -sL "https://github.com/FairwindsOps/pluto/releases/download/${PLUTO_VERSION}/pluto_${PLUTO_VERSION#v}_linux_amd64.tar.gz" \
            | tar -xz -C /usr/local/bin pluto

          npm install -g @anthropic-ai/claude-code >/dev/null 2>&1

          echo "=== Cloning home-cluster ==="
          git clone "https://x-access-token:${GITHUB_TOKEN}@github.com/Tsuguya/home-cluster.git" /workspace
          cd /workspace

          echo "=== Running Pluto ==="
          pluto detect-all-in-cluster --target-versions k8s=v1.36.0 -o wide 2>&1 | tee /tmp/pluto-cluster.txt || true
          pluto detect-helm --target-versions k8s=v1.36.0 -o wide 2>&1 | tee /tmp/pluto-helm.txt || true

          echo "[detect-all-in-cluster]"
          cat /tmp/pluto-cluster.txt
          echo "[detect-helm]"
          cat /tmp/pluto-helm.txt

          if ! grep -qE "DEPRECATED|REMOVED" /tmp/pluto-cluster.txt /tmp/pluto-helm.txt 2>/dev/null; then
            echo "No deprecated APIs detected in ai-fix step"
            exit 0
          fi

          cat > /tmp/prompt.txt << 'PROMPT_EOF'
          Kubernetes クラスターで deprecated API が検出されました（対象: k8s v1.36.0）。

          この home-cluster リポジトリの manifests/ と helm-values/ を調査して、
          deprecated/removed な apiVersion を新しい apiVersion に更新してください。

          git 操作は行わないでください（スクリプトが処理します）。

          ## Pluto detect-all-in-cluster
          PROMPT_EOF

          cat /tmp/pluto-cluster.txt >> /tmp/prompt.txt
          echo "" >> /tmp/prompt.txt
          echo "## Pluto detect-helm" >> /tmp/prompt.txt
          cat /tmp/pluto-helm.txt >> /tmp/prompt.txt

          echo "=== Running Claude Code ==="
          claude --print "$(cat /tmp/prompt.txt)" \
            --allowedTools Edit,Read,Bash,Glob,Grep,Write

          if ! git diff --quiet HEAD || git ls-files --others --exclude-standard | grep -q .; then
            :
          else
            echo "No changes made by Claude"
            exit 1
          fi

          echo "=== Creating signed commit via GitHub GraphQL API ==="
          BRANCH="fix/deprecated-api-$(date +%Y%m%d-%H%M%S)"
          export BRANCH

          python3 << 'PYEOF'
          import subprocess, json, base64, sys, os

          REPO = "Tsuguya/home-cluster"
          BRANCH = os.environ["BRANCH"]

          MUTATION = """
          mutation ($input: CreateCommitOnBranchInput!) {
            createCommitOnBranch(input: $input) {
              commit { oid }
            }
          }
          """

          def gh_api(endpoint, method="GET", data=None):
              cmd = ["gh", "api", f"repos/{REPO}/{endpoint}", "--method", method]
              if data:
                  cmd += ["--input", "-"]
              inp = json.dumps(data).encode() if data else None
              r = subprocess.run(cmd, input=inp, capture_output=True, cwd="/workspace")
              if r.returncode != 0:
                  print(f"ERROR ({endpoint}): {r.stderr.decode()}", file=sys.stderr)
                  sys.exit(1)
              return json.loads(r.stdout) if r.stdout.strip() else {}

          def gh_graphql(variables):
              payload = json.dumps({"query": MUTATION, "variables": variables}).encode()
              r = subprocess.run(
                  ["gh", "api", "graphql", "--input", "-"],
                  input=payload, capture_output=True, cwd="/workspace"
              )
              if r.returncode != 0:
                  print(f"GraphQL ERROR: {r.stderr.decode()}", file=sys.stderr); sys.exit(1)
              result = json.loads(r.stdout)
              if "errors" in result:
                  print(f"GraphQL errors: {result['errors']}", file=sys.stderr); sys.exit(1)
              return result["data"]

          # Changed files
          modified = subprocess.run(
              ["git", "diff", "--name-only", "HEAD"],
              capture_output=True, text=True, cwd="/workspace"
          ).stdout.strip().splitlines()
          new_files = subprocess.run(
              ["git", "ls-files", "--others", "--exclude-standard"],
              capture_output=True, text=True, cwd="/workspace"
          ).stdout.strip().splitlines()
          deleted = subprocess.run(
              ["git", "diff", "--name-only", "--diff-filter=D", "HEAD"],
              capture_output=True, text=True, cwd="/workspace"
          ).stdout.strip().splitlines()

          additions = [
              {"path": f, "contents": base64.b64encode(open(f"/workspace/{f}", "rb").read()).decode()}
              for f in modified + new_files if f and f not in deleted
          ]
          deletions = [{"path": f} for f in deleted if f]
          print(f"Additions: {[a['path'] for a in additions]}, Deletions: {deletions}")

          # Get base SHA and create branch
          base_sha = gh_api("git/ref/heads/main")["object"]["sha"]
          gh_api("git/refs", "POST", {"ref": f"refs/heads/{BRANCH}", "sha": base_sha})
          print(f"Branch created: {BRANCH}")

          # Create signed commit via GraphQL (GitHub signs automatically)
          result = gh_graphql({
              "input": {
                  "branch": {"repositoryNameWithOwner": REPO, "branchName": BRANCH},
                  "message": {
                      "headline": "fix: update deprecated Kubernetes API versions for k8s v1.36.0",
                      "body": "Auto-fixed by Claude Code (triggered by Pluto check).\nReview before merging."
                  },
                  "fileChanges": {"additions": additions, "deletions": deletions},
                  "expectedHeadOid": base_sha
              }
          })
          print(f"Signed commit: {result['createCommitOnBranch']['commit']['oid']}")
          PYEOF

          cat > /tmp/pr-body.txt << 'BODY_EOF'
          ## Summary

          Pluto が k8s v1.36.0 で deprecated/removed となる API を検出したため、Claude Code が自動修正しました。

          ## Pluto 検出結果

          ```
          BODY_EOF

          cat /tmp/pluto-cluster.txt >> /tmp/pr-body.txt
          cat /tmp/pluto-helm.txt >> /tmp/pr-body.txt
          printf '```\n\n---\n> 自動生成された PR です。マージ前に変更内容を必ず確認してください。\n' >> /tmp/pr-body.txt

          gh pr create \
            --title "fix: update deprecated Kubernetes API versions (k8s v1.36.0)" \
            --body-file /tmp/pr-body.txt \
            --head "$BRANCH" \
            --base main

          echo "PR created for branch: $BRANCH"

    - name: fail-if-deprecated
      container:
        image: alpine:3.23
        resources:
          requests:
            cpu: 10m
            memory: 16Mi
          limits:
            memory: 64Mi
        command: [sh, -c]
        args:
          - |
            echo "Deprecated APIs found. PR has been created for review."
            exit 1
---
apiVersion: argoproj.io/v1alpha1
kind: CronWorkflow
metadata:
  name: pluto-check
  namespace: argo
spec:
  schedule: "0 10 * * 0"
  timezone: Asia/Tokyo
  concurrencyPolicy: Replace
  workflowSpec:
    workflowTemplateRef:
      name: pluto-check
