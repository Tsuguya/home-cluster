global:
  logging:
    format: json
  securityContext:
    runAsNonRoot: true
    seccompProfile:
      type: RuntimeDefault

controller:
  resources:
    requests:
      cpu: 50m
      memory: 512Mi
    limits:
      memory: 1536Mi

applicationSet:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      memory: 192Mi

configs:
  cm:
    resource.exclusions: |
      - apiGroups:
          - cilium.io
        kinds:
          - CiliumIdentity
        clusters:
          - "*"
    admin.enabled: "false"
    url: https://argocd.infra.tgy.io
    oidc.config: |
      name: Kanidm
      issuer: https://idm.infra.tgy.io/oauth2/openid/argocd
      clientID: argocd
      enablePKCEAuthentication: true
      requestedScopes:
        - openid
        - profile
        - email
  rbac:
    policy.csv: |
      p, role:owner, applications, *, */*, allow
      p, role:owner, applicationsets, *, */*, allow
      p, role:owner, clusters, *, *, allow
      p, role:owner, repositories, *, *, allow
      p, role:owner, certificates, *, *, allow
      p, role:owner, accounts, *, *, allow
      p, role:owner, gpgkeys, *, *, allow
      p, role:owner, logs, get, */*, allow
      p, role:owner, exec, create, */*, allow
      p, role:owner, projects, *, *, allow
      p, role:owner, extensions, invoke, *, allow
      p, role:owner, applications, delete, storage/*, deny
      p, role:owner, applications, delete, platform/*, deny
      p, role:owner, applications, delete, security/*, deny
      p, role:readonly, applications, get, */*, allow
      p, role:readonly, projects, get, *, allow
      p, role:readonly, clusters, get, *, allow
      p, role:readonly, logs, get, */*, allow
      p, role:readonly, exec, create, */*, deny
      g, tsuguya.toma@tgy.io, role:owner
    policy.default: ""
    scopes: "[email]"
  params:
    server.insecure: "false"

dex:
  enabled: false

repoServer:
  resources:
    requests:
      cpu: 10m
      memory: 128Mi
    limits:
      memory: 1Gi
  livenessProbe:
    enabled: false

redis:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      memory: 256Mi
  automountServiceAccountToken: false
  securityContext:
    runAsNonRoot: true
    runAsUser: 999
    seccompProfile:
      type: RuntimeDefault
  containerSecurityContext:
    allowPrivilegeEscalation: false
    readOnlyRootFilesystem: true
    capabilities:
      drop:
        - ALL

server:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      memory: 256Mi
  certificate:
    enabled: true
    domain: argocd.infra.tgy.io
    issuer:
      kind: ClusterIssuer
      name: letsencrypt-prod
  httproute:
    enabled: false
  grpcroute:
    enabled: false

notifications:
  resources:
    requests:
      cpu: 10m
      memory: 64Mi
    limits:
      memory: 128Mi
  secret:
    create: false
  notifiers:
    service.webhook.discord: |
      url: $url
      headers:
        - name: Content-Type
          value: application/json
  subscriptions:
    - recipients:
        - discord
      triggers:
        - on-sync-succeeded
        - on-sync-failed
        - on-health-degraded
  triggers:
    trigger.on-sync-succeeded: |
      - description: Application syncing has succeeded
        send:
          - app-sync-succeeded
        when: app.status.operationState.phase in ['Succeeded']
    trigger.on-sync-failed: |
      - description: Application syncing has failed
        send:
          - app-sync-failed
        when: app.status.operationState.phase in ['Error', 'Failed']
    trigger.on-health-degraded: |
      - description: Application has degraded
        send:
          - app-health-degraded
        when: app.status.health.status == 'Degraded'
  templates:
    template.app-sync-succeeded: |
      webhook:
        discord:
          method: POST
          body: |
            {
              "embeds": [{
                "title": "{{.app.metadata.name}} synced",
                "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "color": 1620818,
                "fields": [
                  {"name": "Sync Status", "value": "{{.app.status.sync.status}}", "inline": true},
                  {"name": "Revision", "value": "{{.app.status.sync.revision | trunc 7 }}", "inline": true}
                ]
              }]
            }
    template.app-sync-failed: |
      webhook:
        discord:
          method: POST
          body: |
            {
              "embeds": [{
                "title": "{{.app.metadata.name}} sync failed",
                "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}?operation=true",
                "color": 15298678,
                "fields": [
                  {"name": "Error", "value": "{{.app.status.operationState.message | trunc 500 }}", "inline": false}
                ]
              }]
            }
    template.app-health-degraded: |
      webhook:
        discord:
          method: POST
          body: |
            {
              "embeds": [{
                "title": "{{.app.metadata.name}} health degraded",
                "url": "{{.context.argocdUrl}}/applications/{{.app.metadata.name}}",
                "color": 16040976,
                "fields": [
                  {"name": "Health", "value": "{{.app.status.health.status}}", "inline": true}
                ]
              }]
            }
