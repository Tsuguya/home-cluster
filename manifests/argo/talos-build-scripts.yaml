apiVersion: v1
kind: ConfigMap
metadata:
  name: talos-build-scripts
  namespace: argo
data:
  push-installer.sh: |
    #!/bin/sh
    set -euo pipefail
    wget -qO /tmp/crane.tar.gz "https://github.com/google/go-containerregistry/releases/download/v0.20.7/go-containerregistry_Linux_x86_64.tar.gz"
    tar xzf /tmp/crane.tar.gz -C /tmp crane
    chmod +x /tmp/crane
    export PATH="/tmp:$PATH"
    INSTALLER_TAR=$(find /tmp/artifact -name '*.tar' | head -1)
    echo "=== Pushing SecureBoot installer: ${INSTALLER_TAR} ==="
    crane auth login ghcr.io -u tsuguya -p "${GITHUB_TOKEN}"
    crane push "${INSTALLER_TAR}" "ghcr.io/tsuguya/installer:${VERSION}"
    echo "=== Done ==="

  push-iso.sh: |
    #!/bin/sh
    set -euo pipefail

    wget -qO /tmp/jq "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64"
    chmod +x /tmp/jq
    wget -qO /tmp/gh.tar.gz "https://github.com/cli/cli/releases/download/v2.74.1/gh_2.74.1_linux_amd64.tar.gz"
    tar xzf /tmp/gh.tar.gz -C /tmp gh_2.74.1_linux_amd64/bin/gh --strip-components=2
    chmod +x /tmp/gh
    export PATH="/tmp:$PATH"

    _apk=/tmp/apk; mkdir -p $_apk/etc/apk; cp -r /etc/apk/keys $_apk/etc/apk/
    apk add --root $_apk --initdb --usermode --no-cache \
      --repositories-file /etc/apk/repositories 7zip > /dev/null
    export PATH="$_apk/usr/bin:$PATH" LD_LIBRARY_PATH="$_apk/usr/lib:$_apk/lib"

    SB_ISO=$(find /tmp/sb-iso -name '*.iso' | head -1)
    ISO=$(find /tmp/iso -name '*.iso' | head -1)

    echo "=== Extracting PXE assets from: ${ISO} ==="
    7z x "${ISO}" -o/tmp/pxe boot/vmlinuz boot/initramfs.xz
    mv /tmp/pxe/boot/vmlinuz /tmp/vmlinuz-amd64
    mv /tmp/pxe/boot/initramfs.xz /tmp/initramfs-amd64.xz

    echo "=== Uploading artifacts to GitHub Release ${VERSION} ==="
    gh release upload "${VERSION}" \
      "${SB_ISO}" \
      /tmp/vmlinuz-amd64 \
      /tmp/initramfs-amd64.xz \
      --repo Tsuguya/talos-custom-build \
      --clobber
    echo "=== Done ==="

  finalize-release.sh: |
    #!/bin/sh
    set -euo pipefail
    wget -qO /tmp/gh.tar.gz "https://github.com/cli/cli/releases/download/v2.74.1/gh_2.74.1_linux_amd64.tar.gz"
    tar xzf /tmp/gh.tar.gz -C /tmp gh_2.74.1_linux_amd64/bin/gh --strip-components=2
    chmod +x /tmp/gh
    export PATH="/tmp:$PATH"

    gh release edit "${VERSION}" \
      --repo Tsuguya/talos-custom-build \
      --prerelease=false \
      --notes "Custom Talos build with UFS + SecureBoot.

    - Talos: ${VERSION}
    - SecureBoot: Signed UKI + auto-enrollment ISO
    - System extensions: iscsi-tools, spin"
    echo "=== Release finalized ==="
