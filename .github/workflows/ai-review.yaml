name: AI Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  ai-review:
    if: >-
      github.actor == 'renovate[bot]' &&
      !contains(github.event.pull_request.body, '**Automerge**: Enabled')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "renovate[bot]"
          claude_args: "--model claude-sonnet-4-6 --max-turns 10 --disallowedTools Edit,Write,NotebookEdit"
          prompt: |
            You are reviewing a Renovate dependency update PR for a Kubernetes homelab cluster managed by ArgoCD.

            Repository structure:
            - apps/ — ArgoCD Application definitions
            - helm-values/ — Helm chart values (one directory per service)
            - manifests/ — Raw K8s manifests

            Steps:
            1. Run `gh pr view ${{ github.event.pull_request.number }}` to read the PR description and release notes
            2. Run `gh pr diff ${{ github.event.pull_request.number }}` to see the changes
            3. Read the relevant helm-values/ files to check if the update affects any configured options
            4. If the PR description lacks sufficient release notes, search the web for the changelog
            5. Evaluate:
               - No breaking changes affecting our values configuration
               - No deprecated options we currently use
               - No known critical bugs in the new version

            Decision:
            - SAFE: Run `gh pr review ${{ github.event.pull_request.number }} --approve -b "AI Review: No breaking changes detected."` then `gh pr merge ${{ github.event.pull_request.number }} --squash`
            - CONCERNS: Run `gh pr comment ${{ github.event.pull_request.number }} -b "<your detailed concerns>"` — do NOT approve or merge
