name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  yamllint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: frenck/action-yamllint@v1

  kubeconform:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install kubeconform
        run: |
          curl -fsSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin

      - name: Validate manifests
        run: |
          kubeconform -strict -ignore-missing-schemas \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -summary manifests/

      - name: Validate ArgoCD Applications
        run: |
          kubeconform -strict \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -summary apps/ argocd/

  helm-template:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Install tools
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq
          curl -fsSL https://github.com/yannh/kubeconform/releases/latest/download/kubeconform-linux-amd64.tar.gz \
            | tar xz -C /usr/local/bin

      - name: Validate Helm templates
        run: |
          set -euo pipefail
          declare -A added_repos

          # Phase 1: collect and add all helm repos
          for app_file in apps/*.yaml; do
            source_count=$(yq '.spec.sources | length' "$app_file")
            [[ "$source_count" == "0" ]] && continue
            for i in $(seq 0 $((source_count - 1))); do
              chart=$(yq ".spec.sources[$i].chart" "$app_file")
              [[ "$chart" == "null" ]] && continue
              repo_url=$(yq ".spec.sources[$i].repoURL" "$app_file")
              alias="r$(echo "$repo_url" | sha256sum | cut -c1-8)"
              if [[ -z "${added_repos[$alias]+_}" ]]; then
                helm repo add "$alias" "$repo_url"
                added_repos[$alias]=1
              fi
            done
          done
          helm repo update

          # Phase 2: helm template | kubeconform
          for app_file in apps/*.yaml; do
            source_count=$(yq '.spec.sources | length' "$app_file")
            [[ "$source_count" == "0" ]] && continue
            app_name=$(yq '.metadata.name' "$app_file")
            namespace=$(yq '.spec.destination.namespace' "$app_file")
            for i in $(seq 0 $((source_count - 1))); do
              chart=$(yq ".spec.sources[$i].chart" "$app_file")
              [[ "$chart" == "null" ]] && continue
              repo_url=$(yq ".spec.sources[$i].repoURL" "$app_file")
              revision=$(yq ".spec.sources[$i].targetRevision" "$app_file")
              release_name=$(yq ".spec.sources[$i].helm.releaseName" "$app_file")
              alias="r$(echo "$repo_url" | sha256sum | cut -c1-8)"
              values_args=()
              while IFS= read -r vf; do
                [[ -z "$vf" || "$vf" == "null" ]] && continue
                actual="${vf/\$values\//}"
                [[ -f "$actual" ]] && values_args+=("-f" "$actual")
              done < <(yq ".spec.sources[$i].helm.valueFiles[]" "$app_file" 2>/dev/null || true)
              echo ">>> $app_name: $chart@$revision"
              helm template "$release_name" "$alias/$chart" \
                --version "$revision" \
                --namespace "$namespace" \
                "${values_args[@]}" \
                | kubeconform -strict -ignore-missing-schemas \
                  -schema-location default \
                  -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
                  -summary
            done
          done

  ai-review:
    needs: [yamllint, kubeconform, helm-template]
    if: >-
      github.event_name == 'pull_request' &&
      github.actor == 'renovate[bot]' &&
      !contains(github.event.pull_request.body, '**Automerge**: Enabled')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
    steps:
      - uses: actions/checkout@v6

      - uses: actions/setup-node@v4
        with:
          node-version: "24"

      - name: Install MCP server dependencies
        run: npm ci
        working-directory: .github/mcp/pr-review

      - uses: azure/setup-helm@v4

      - name: Create MCP config
        run: |
          cat > /tmp/mcp-config.json << EOF
          {
            "mcpServers": {
              "pr-review": {
                "command": "npx",
                "args": ["tsx", "src/index.ts"],
                "cwd": "${GITHUB_WORKSPACE}/.github/mcp/pr-review",
                "env": {
                  "GITHUB_TOKEN": "${GITHUB_TOKEN}"
                }
              }
            }
          }
          EOF
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          allowed_bots: "renovate[bot]"
          claude_args: "--model claude-sonnet-4-6 --max-turns 15 --disallowedTools Edit,Write,NotebookEdit --allowedTools 'Bash(gh:*)' Read 'mcp__pr-review__*' --mcp-config /tmp/mcp-config.json"
          prompt: |
            You are reviewing a Renovate dependency update PR for a Kubernetes homelab cluster managed by ArgoCD.

            You have MCP tools for efficient review. Follow this workflow:

            Step 1: Get PR summary
            Use `get_pr_summary` with pr_number=${{ github.event.pull_request.number }} to get structured PR info including update type, package versions, release notes, and affected files.

            Step 2: If update_type is "helm", run helm values diff
            Use `helm_values_diff` with the chart's repo_url, chart name, old/new versions (from step 1), and user_values_path (from affected_helm_values in step 1).
            This writes detailed diffs to /tmp/pr-review/diff/ — check the summary first.

            Step 3: Check app version change
            If `app_version_change` is present, the underlying application version also changed (e.g., ArgoCD chart bump includes ArgoCD server version bump).
            - Check `app_version_change.level` — major/minor upgrades need careful review
            - If `app_version_change.release_notes_file` exists, use `Read` on `/tmp/pr-review/app-release-notes.md` for upstream release notes
            - This is often where breaking changes actually live (chart changes are usually just values, app changes affect behavior)

            Step 4: Deep dive if needed
            - If removed_keys or impact_on_user_values has entries, use `Read` on the relevant section diff files in /tmp/pr-review/diff/sections/
            - If release_notes_summary mentions breaking/deprecated keywords, use `Read` on /tmp/pr-review/release-notes.md
            - Read the relevant helm-values/ files to verify your understanding

            Step 5: Evaluate
            - No breaking changes affecting our values configuration
            - No deprecated options we currently use
            - No removed keys that we depend on
            - No known critical bugs in the new version

            Decision:
            - SAFE: Run `gh pr review ${{ github.event.pull_request.number }} --approve -b "AI Review: <brief summary of what was checked>"` then `gh pr merge ${{ github.event.pull_request.number }} --squash`
            - CONCERNS: Run `gh pr comment ${{ github.event.pull_request.number }} -b "<your detailed concerns>"` — do NOT approve or merge
