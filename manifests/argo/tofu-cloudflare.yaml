apiVersion: v1
kind: ServiceAccount
metadata:
  name: tofu-executor
  namespace: argo
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tofu-executor
  namespace: argo
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: argo-workflows-edit
subjects:
  - kind: ServiceAccount
    name: tofu-executor
    namespace: argo
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: tofu-state-manager
  namespace: argo
rules:
  - apiGroups: [""]
    resources: ["secrets"]
    verbs: ["get", "list", "create", "update", "patch", "delete"]
  - apiGroups: ["coordination.k8s.io"]
    resources: ["leases"]
    verbs: ["get", "list", "create", "update", "delete"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: tofu-state-manager
  namespace: argo
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: tofu-state-manager
subjects:
  - kind: ServiceAccount
    name: tofu-executor
    namespace: argo
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: tofu-cloudflare
  namespace: argo
spec:
  activeDeadlineSeconds: 600
  serviceAccountName: tofu-executor
  entrypoint: main
  arguments:
    parameters:
      - name: command
        default: apply
        enum:
          - plan
          - apply
  templates:
    - name: main
      volumes:
        - name: workspace
          emptyDir: {}
      initContainers:
        - name: git-clone
          image: alpine/git:v2.47.2
          command: [git, clone, --depth, "1"]
          args: ["https://$(GITHUB_TOKEN)@github.com/Tsuguya/home-cloudflare.git", /workspace]
          env:
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-pat-tofu
                  key: credential
          volumeMounts:
            - name: workspace
              mountPath: /workspace
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
      container:
        image: ghcr.io/opentofu/opentofu:1.11.5
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 512Mi
        command: [sh, -c]
        args:
          - |
            cd /workspace
            tofu init
            if [ "{{workflow.parameters.command}}" = "apply" ]; then
              tofu apply -auto-approve
            else
              tofu plan
            fi
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        env:
          - name: CLOUDFLARE_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: api_token
          - name: TF_VAR_cloudflare_account_id
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: account_id
          - name: TF_VAR_cloudflare_zone_id
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: zone_id
          - name: TF_VAR_discord_webhook_url
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: discord_webhook_url
---
apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: tofu-cloudflare-plan
  namespace: argo
spec:
  activeDeadlineSeconds: 600
  serviceAccountName: tofu-executor
  entrypoint: main
  arguments:
    parameters:
      - name: pr-number
      - name: branch
      - name: author
        default: ""
  templates:
    - name: main
      volumes:
        - name: workspace
          emptyDir: {}
      initContainers:
        - name: git-clone
          image: alpine/git:v2.47.2
          command: [sh, -c]
          args:
            - git clone --depth 1 -b "${BRANCH}" "https://${GITHUB_TOKEN}@github.com/Tsuguya/home-cloudflare.git" /workspace
          env:
            - name: BRANCH
              value: "{{workflow.parameters.branch}}"
            - name: GITHUB_TOKEN
              valueFrom:
                secretKeyRef:
                  name: github-pat-tofu
                  key: credential
          volumeMounts:
            - name: workspace
              mountPath: /workspace
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop: [ALL]
      container:
        image: ghcr.io/opentofu/opentofu:1.11.5
        resources:
          requests:
            cpu: 50m
            memory: 128Mi
          limits:
            memory: 512Mi
        command: [sh, -c]
        args:
          - |
            set -uo pipefail
            wget -qO /tmp/jq "https://github.com/jqlang/jq/releases/download/jq-1.7.1/jq-linux-amd64"
            wget -qO /tmp/gh.tar.gz "https://github.com/cli/cli/releases/download/v2.74.1/gh_2.74.1_linux_amd64.tar.gz"
            tar xzf /tmp/gh.tar.gz -C /tmp gh_2.74.1_linux_amd64/bin/gh --strip-components=2
            chmod +x /tmp/jq /tmp/gh
            export PATH="/tmp:$PATH"

            cd /workspace
            tofu init -input=false
            PLAN_OUTPUT=$(tofu plan -detailed-exitcode -no-color 2>&1) && EXIT_CODE=0 || EXIT_CODE=$?
            PR="{{workflow.parameters.pr-number}}"
            REPO="Tsuguya/home-cloudflare"
            if [ "$EXIT_CODE" = "0" ]; then
              TITLE="Tofu Plan: No Changes"
              MSG="Infrastructure is up-to-date."
            elif [ "$EXIT_CODE" = "2" ]; then
              TITLE="Tofu Plan: Changes Detected"
              MSG="Review required before merge."
            else
              TITLE="Tofu Plan: Error"
              MSG="Plan failed with exit code $EXIT_CODE."
            fi
            BODY=$(jq -n \
              --arg title "$TITLE" \
              --arg msg "$MSG" \
              --arg output "$PLAN_OUTPUT" \
              '{body: ("### " + $title + "\n" + $msg + "\n\n<details>\n<summary>Plan Output</summary>\n\n```\n" + $output + "\n```\n\n</details>")}')
            echo "$BODY" | gh api "repos/$REPO/issues/$PR/comments" --input -
            AUTHOR="{{workflow.parameters.author}}"
            if [ "$EXIT_CODE" = "0" ] && [ "$AUTHOR" = "renovate[bot]" ]; then
              gh api "repos/$REPO/pulls/$PR/merge" --method PUT -f merge_method=squash
            fi
        volumeMounts:
          - name: workspace
            mountPath: /workspace
        env:
          - name: GITHUB_TOKEN
            valueFrom:
              secretKeyRef:
                name: github-pat-tofu
                key: credential
          - name: CLOUDFLARE_API_TOKEN
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: api_token
          - name: TF_VAR_cloudflare_account_id
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: account_id
          - name: TF_VAR_cloudflare_zone_id
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: zone_id
          - name: TF_VAR_discord_webhook_url
            valueFrom:
              secretKeyRef:
                name: cloudflare-tofu-credentials
                key: discord_webhook_url
