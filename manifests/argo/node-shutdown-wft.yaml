apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: node-shutdown
  namespace: argo
spec:
  entrypoint: main
  arguments:
    parameters:
      - name: nodes
        description: "Shutdown target"
        enum:
          - cp-01
          - cp-02
          - cp-03
          - wn-01
          - wn-02
          - wn-03
          - all-workers
          - all
  volumes:
    - name: talosconfig
      secret:
        secretName: talosconfig
  templates:
    - name: main
      steps:
        - - name: resolve
            template: resolve-nodes
            arguments:
              parameters:
                - name: nodes
                  value: "{{workflow.parameters.nodes}}"
        - - name: shutdown
            template: shutdown-nodes
            arguments:
              parameters:
                - name: ips
                  value: "{{steps.resolve.outputs.parameters.ips}}"
                - name: exec-node
                  value: "{{steps.resolve.outputs.parameters.exec-node}}"
    - name: resolve-nodes
      inputs:
        parameters:
          - name: nodes
      script:
        image: alpine:3.21
        command: [sh]
        source: |
          TARGET="{{inputs.parameters.nodes}}"

          # Resolve target to IPs
          case "$TARGET" in
            cp-01) IPS="192.168.0.230" ;;
            cp-02) IPS="192.168.0.231" ;;
            cp-03) IPS="192.168.0.232" ;;
            wn-01) IPS="192.168.0.200" ;;
            wn-02) IPS="192.168.0.201" ;;
            wn-03) IPS="192.168.0.202" ;;
            all-workers) IPS="192.168.0.200,192.168.0.201,192.168.0.202" ;;
            all) IPS="192.168.0.230,192.168.0.231,192.168.0.232,192.168.0.200,192.168.0.201,192.168.0.202" ;;
            *) IPS="$TARGET" ;;
          esac

          # Pick a node NOT in the shutdown target to execute from
          case "$TARGET" in
            cp-*) EXEC="wn-01" ;;
            *)    EXEC="cp-01" ;;
          esac

          echo -n "$IPS" > /tmp/ips
          echo -n "$EXEC" > /tmp/exec-node
      outputs:
        parameters:
          - name: ips
            valueFrom:
              path: /tmp/ips
          - name: exec-node
            valueFrom:
              path: /tmp/exec-node
    - name: shutdown-nodes
      inputs:
        parameters:
          - name: ips
          - name: exec-node
      nodeSelector:
        kubernetes.io/hostname: "{{inputs.parameters.exec-node}}"
      tolerations:
        - key: node-role.kubernetes.io/control-plane
          operator: Exists
          effect: NoSchedule
      container:
        image: ghcr.io/siderolabs/talosctl:v1.12.4
        command: [/talosctl]
        args:
          - shutdown
          - --nodes
          - "{{inputs.parameters.ips}}"
          - --talosconfig
          - /talos/config
        volumeMounts:
          - name: talosconfig
            mountPath: /talos
            readOnly: true
